<!DOCTYPE html>
<html>

<head>
  <title>Roevhul - game</title>
  <!-- <link rel="icon" href="/public/favicon.ico"></link> -->
  <link rel="stylesheet" href="/public/reset.css">
  <link rel="stylesheet" href="/public/cards/classic-playset.css">
  <link rel="stylesheet" href="/public/style.css">
  <link rel="stylesheet" href="/public/game.css">
  <!-- <script defer src="/public/app.js"></script> -->
</head>

<body>
  <header>
    <h1>Roevhul - GAME ON</h1>
    <nav>
      <ul>
        <li><a href="/lobby">Lobby</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>
  </header>
  
  <div class="content">
    <main>

      <div class="circle" id="table">
      </div>
      
    </main>
    <aside>
      <div class="players-list-section">
        <h3>Players</h3>
        <ul id="players-list" class="players-list"></ul>
      </div>
      
      <div class="chat-messages-section">
        <h3>Chat</h3>
        <ul id="chat-messages" class="chat-messages"></ul>
      </div>

      <div class="post-chat-message-section">
        <textarea id="player-chat" rows="2"></textarea>
        <button type="button" id="send-message">Send</button>
      </div>
    </aside>
  </div>

  <template id="table-player">
    <div class="item player-container"> <!-- style="--i: playerIndex; --total: numPlayers" -->
      <div class="player-name"></div>
      <div class="classic-playset" style="margin-top:50px;height:200px;">
        <div class="hand">
    			<card class="back"><div data-suit="hearts" data-rank="6">&hearts;</div></card>
		      <!-- <card><div data-suit="spades" data-rank="K">&#9818;</div></card>
          <card><div data-suit="diamonds" data-rank="2">&#9830;</div></card> -->
        </div>
  		</div>
    </div>
  </template>

  <template id="message">
    <li>
      <div></div>
      <p></p>
    </li>
  </template>

  <script>
    const url = new URL(`${location.href}/start_web_socket`);
    url.protocol = url.protocol.replace('http', 'ws');
    const socket = new WebSocket(url);

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      switch (data.event) {
        case "update-users":
          updatePlayerList(data.players);
          updateTable(data.players);
          break;

        case "send-message":
          addMessageToChat(data.player, data.message);
          break;
      }
    };

    function updateTable(players) {
      const template = document.getElementById("table-player");
      const table = document.getElementById("table");
      table.replaceChildren();

      for (const i in players) {
        const player = players[i];
        const clone = template.content.cloneNode(true);

        clone.querySelector(".player-container").style = `--i: ${i}; --total: ${players.length}`;
        clone.querySelector(".player-name").textContent = player;
        table.append(clone);
      }
    }

    function updatePlayerList(players) {
      const playersList = document.getElementById("players-list");
      playersList.replaceChildren();

      for (const player of players) {
        const listItem = document.createElement("li");
        listItem.textContent = player;
        playersList.appendChild(listItem);
      }
    }

    function addMessageToChat(player, message) {
      const chat = document.getElementById("chat-messages");
      const template = document.getElementById("message");
      const clone = template.content.cloneNode(true);

      clone.querySelector("div").textContent = player;
      clone.querySelector("p").textContent = message;
      chat.prepend(clone);
    }

    const playerChat = document.getElementById("player-chat");
    const sendMessageBtn = document.getElementById("send-message");
    sendMessageBtn.addEventListener("click", e => {
      const message = playerChat.value;
      playerChat.value = "";
      socket.send(JSON.stringify({ event: "send-message", message }));
    });
  </script>
</body>

</html>