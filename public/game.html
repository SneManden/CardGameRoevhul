<!DOCTYPE html>
<html>

<head>
  <title>Roevhul - game</title>

  <!-- <link rel="icon" href="/public/favicon.ico"></link> -->

  <link rel="stylesheet" href="/public/reset.css">
  <link rel="stylesheet" href="/public/style.css">
  <link rel="stylesheet" href="/public/game.css">

  <script src='/public/cards/elements.cardmeister.full.js'></script>
</head>

<body>
  <header>
    <h1>Roevhul - GAME ON</h1>
    <nav>
      <ul>
        <li><a href="/lobby">Lobby</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>
  </header>
	
  <div class="content">
    <main>

      <div class="circle" id="table">
      </div>

      <div id="hud">
        <div class="hand player-hand">
    			<playing-card cid=As></playing-card>
          <playing-card suit=Hearts rank=10></playing-card>
          <playing-card suit=3 rank=Queen></playing-card>
        </div>
      </div>
      
    </main>
    <aside>
      <div class="players-list-section">
        <h3>Players</h3>
        <ul id="players-list" class="players-list"></ul>
      </div>
      
      <div class="chat-messages-section">
        <h3>Chat</h3>
        <ul id="chat-messages" class="chat-messages"></ul>
      </div>

      <div class="post-chat-message-section">
        <textarea id="player-chat" rows="2"></textarea>
        <button type="button" id="send-message">Send</button>
      </div>
    </aside>
  </div>

  <template id="table-player">
    <div class="item player-container">
      <div class="player-name"></div>
      <div class="hand"></div>
    </div>
  </template>

  <template id="message">
    <li>
      <div></div>
      <p></p>
    </li>
  </template>

  <script>
    const url = new URL(`${location.href}/start_web_socket`);
    url.protocol = url.protocol.replace('http', 'ws');
    const socket = new WebSocket(url);

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      switch (data.event) {
        case "update-users":
          // data.players.push("Alice", "Bob", "Charlie", "Denise");
          updatePlayerList(data.players);
          updateTable(data.players);
          break;

        case "send-message":
          addMessageToChat(data.player, data.message);
          break;
        
        default:
          console.log("onmessage(event):", event.data);
          break;
      }
    };

    function updateTable(players) {
      const template = document.getElementById("table-player");
      const table = document.getElementById("table");
      table.replaceChildren();

      for (const i in players) {
        const player = players[i];
        const clone = template.content.cloneNode(true);

        clone.querySelector(".player-container").style = `--i: ${i}; --total: ${players.length}`;
        clone.querySelector(".player-name").textContent = player;
        
        for (let i=0; i<Math.floor(Math.random() * 6)+1; i++) {
          const card = document.createElement("playing-card");
          card.setAttribute("cid", 0);
          clone.querySelector(".hand").appendChild(card);
        }
        
        table.append(clone);
      }
    }

    function updatePlayerList(players) {
      const playersList = document.getElementById("players-list");
      playersList.replaceChildren();

      for (const player of players) {
        const listItem = document.createElement("li");
        listItem.textContent = player;
        playersList.appendChild(listItem);
      }
    }

    function addMessageToChat(player, message) {
      const chat = document.getElementById("chat-messages");
      const template = document.getElementById("message");
      const clone = template.content.cloneNode(true);

      clone.querySelector("div").textContent = player;
      clone.querySelector("p").textContent = message;
      chat.prepend(clone);
    }

    const playerChat = document.getElementById("player-chat");
    const sendMessageBtn = document.getElementById("send-message");
    sendMessageBtn.addEventListener("click", e => {
      const message = playerChat.value;
      playerChat.value = "";
      socket.send(JSON.stringify({ event: "send-message", message }));
    });

    function handleCardClicked(cid) {
      console.log("Card clicked", cid);
    }

    const hand = document.getElementById("hud").querySelector(".hand");
    hand.addEventListener("click", e => {
      const cardClicked = e.target.parentElement;
      const cardCid = e.target.getAttribute("cid");
      console.log("Clicked", cardClicked);

      if (cardCid !== null && cardCid !== undefined) {
        handleCardClicked(cardCid);
        socket.send(JSON.stringify({ event: "action", id: 0, move: cardCid }));
      }
    });
  </script>
</body>

</html>