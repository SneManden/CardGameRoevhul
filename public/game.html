<!DOCTYPE html>
<html>

<head>
  <title>Roevhul - game</title>

  <!-- <link rel="icon" href="/public/favicon.ico"></link> -->

  <link rel="stylesheet" href="/public/reset.css">
  <link rel="stylesheet" href="/public/style.css">
  <link rel="stylesheet" href="/public/game.css">

  <script src='/public/cards/elements.cardmeister.full.js'></script>
</head>

<body>
  <header>
    <h1>Roevhul - GAME ON</h1>
    <nav>
      <ul>
        <li><a href="/lobby">Lobby</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </nav>
  </header>
	
  <div class="content">
    <main>

      <div class="circle" id="table">
        <div id="pile"></div>
        <div id="seats"></div>
      </div>

      <div id="hud">
        <div class="hand player-hand">
        </div>
        <div class="controls">
          <button id="sort-hand">Sort hand</button>
          <button id="pass">Pass</button>
        </div>
      </div>
      
    </main>
    <aside>
      <div class="players-list-section">
        <h3>Players</h3>
        <ul id="players-list" class="players-list"></ul>
      </div>
      
      <div class="chat-messages-section">
        <h3>Chat</h3>
        <ul id="chat-messages" class="chat-messages"></ul>
      </div>

      <div class="post-chat-message-section">
        <textarea id="player-chat" rows="2"></textarea>
        <button type="button" id="send-message">Send</button>
      </div>
    </aside>
  </div>

  <template id="table-player">
    <div class="item player-container">
      <div class="player-name"></div>
      <div class="hand"></div>
    </div>
  </template>

  <template id="message">
    <li>
      <div></div>
      <p></p>
    </li>
  </template>

  <script>
    const url = new URL(`${location.href}/start_web_socket`);
    url.protocol = url.protocol.replace('http', 'ws');
    const socket = new WebSocket(url);

    let playerUsernames = [];

    const playerHand = document.getElementById("hud").querySelector(".hand");
    const passBtn = document.getElementById("hud").querySelector("#pass");
    const sortHandBtn = document.getElementById("hud").querySelector("#sort-hand");
    const playersList = document.getElementById("players-list");
    const table = document.getElementById("table");
    const seats = table.querySelector("#seats");
    const pile = table.querySelector("#pile");
    
    let isSorted = false;

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      console.log("onmessage", data);

      switch (data.event) {
        case "update-users":
          playerUsernames = data.players;
          updatePlayerList(data.players);
          updateTable(data.players);
          break;

        case "send-message":
          addMessageToChat(data.player, data.message);
          break;

        case "state":
          updateState(data.state);
          break;

        case "send-response":
          addMessageToChat("System", data.message, true);
          break;
        
        case "player-move":
          animatePlayerMove(data.username, data.move);
          break;
        
        default:
          console.log("onmessage(event):", data);
          break;
      }
    };

    /**
      @param {string} username
      @param {string[] | "pass"} move
      @return {Promise<void>}
    */
    function animatePlayerMove(username, move) {
      if (move === "pass") {
        // 0. Show text bubble with "pass" from user
        // TODO
        return;
      }

      // 1. create new card(s) with origin at player
      for (const cid of move) {
        const card = document.createElement("playing-card");
        card.setAttribute("cid", cid);
        pile.append(card);
        
        // 2. animate a throw towards middle face up
        const start = getPlayerPosition(username);
        const target = getTargetPosition();
        card.style.left = `${Math.round(start.x - target.x)}px`;
        card.style.top = `${Math.round(start.y - target.y)}px`;
        
        animateThrowCard(card, start, target);
      }

      // 3. if clear (10/joker), then change pile on table face down
    }

    /**
      @param {number} min
      @param {number} max
      @return {number}
    */
    const randomNumber = (min, max) => Math.random()*(max-min) + min;

    /**
      @param {HTMLElement} card
      @param {{ x: number, y: number }} start
      @param {{ x: number, y: number }} target
      @return {{ x: number, y: number }}
    */
    function animateThrowCard(card, start, target, duration=1_000) {
      console.log("animateThrowCard(card:", card, ", start:", start, ", target:", target, ")");
      const translateX = Math.round(target.x - start.x + randomNumber(-5, 5));
      const translateY = Math.round(target.y - start.y + randomNumber(-5, 5));
      const rotate = Math.round(randomNumber(-25, 25));
      card.animate([
        { transform: `translate(${translateX}px, ${translateY}px) rotate(${rotate}deg)` }
      ], { duration: duration, fill: "forwards" });
    }

    /**
      @param {string} username
      @return {{ x: number, y: number }}
    */
    function getPlayerPosition(username) {
      const playerElement = table.querySelector(`[data-player=\"${username}\"]`);
      const rect = playerElement.getBoundingClientRect();
      const position = { x: rect.x, y: rect.y };
      console.log("getPlayerPosition(username:", username, ") =>", position, playerElement);
      return position;
    }

    /**
      @param {string} username
      @return {{ x: number, y: number }}
    */
    function getTargetPosition() {
      const rect = pile.getBoundingClientRect();
      const position = { x: rect.x, y: rect.y };
      console.log("getTargetPosition() =>", position, table);
      return position;
    }

    function updateState(state) {
      updateTable(playerUsernames, state.playerHandCount, state.playerTurn);
      updatePlayerHand(state.hand);
    }

    function updatePlayerHand(hand) {
      playerHand.replaceChildren();
      
      for (const cid of hand) {
        const card = document.createElement("playing-card");
        card.setAttribute("cid", cid);
        playerHand.appendChild(card);
      }

      playerHand.firstElementChild.style.order = 0;
      if (isSorted) {
        sortPlayerHand();
      }
    }

    /**
      @param {string[]} players
      @param {{[key:string]: number}} cardsPerPlayer
      @param {string} currentTurn
      @return {void}
    */
    function updateTable(players, cardsPerPlayer, currentTurn) {
      console.log("updateTable(players:", players, ", cardsPerPlayer:", cardsPerPlayer, ", currentTurn:", currentTurn, ")");
      
      const template = document.getElementById("table-player");
      
      seats.replaceChildren();

      for (const i in players) {
        const player = players[i];
        const clone = template.content.cloneNode(true);

        clone.querySelector(".player-container").style = `--i: ${i}; --total: ${players.length}`;
        clone.querySelector(".player-name").textContent = player;
        
        for (let i=0; i<cardsPerPlayer?.[player] || 0; i++) {
          const card = document.createElement("playing-card");
          card.setAttribute("cid", 0);
          clone.querySelector(".hand").appendChild(card);
        }
        
        seats.append(clone);

        // Cannot set class until _after_ it has been inserted in the DOM (appended to table)
        if (player === currentTurn) {
          const inserted = seats.lastElementChild;
          inserted.setAttribute("data-player", player);
          inserted.classList.add("active");
        }
      }
    }

    passBtn.addEventListener("click", e => {
      socket.send(JSON.stringify({ event: "action", id: 0, move: "pass" }));
    });

    sortHandBtn.addEventListener("click", e => sortPlayerHand());
    function sortPlayerHand() {
      const getOrderingValue = card => card.getAttribute("cid");

      const cards = Array.from(playerHand.querySelectorAll("playing-card"));
      const ordered = cards.sort((a,b) => getOrderingValue(a).localeCompare(getOrderingValue(b)));
      ordered.forEach((cardElement, index) => cardElement.style.order = index);

      isSorted = true;
    }

    playerHand.addEventListener("click", e => {
      const cardClicked = e.target.parentElement;
      const cardCid = cardClicked.getAttribute("cid");
      console.log("Clicked", cardClicked);

      if (cardCid !== null && cardCid !== undefined) {
        socket.send(JSON.stringify({ event: "action", id: 0, move: [cardCid] }));
      }
    });

    function updatePlayerList(players) {
      playersList.replaceChildren();

      for (const player of players) {
        const listItem = document.createElement("li");
        listItem.textContent = player;
        playersList.appendChild(listItem);
      }
    }

    const chat = document.getElementById("chat-messages");
    const playerChat = document.getElementById("player-chat");
    const sendMessageBtn = document.getElementById("send-message");
    sendMessageBtn.addEventListener("click", e => {
      const message = playerChat.value;
      playerChat.value = "";
      socket.send(JSON.stringify({ event: "send-message", message }));
    });

    function addMessageToChat(player, message, fromSystem = false) {
      const template = document.getElementById("message");
      const clone = template.content.cloneNode(true);

      clone.querySelector("div").textContent = player;
      clone.querySelector("p").textContent = message;
      chat.prepend(clone);

      if (fromSystem) {
        chat.firstElementChild.classList.add("system");
      }
    }
  </script>
</body>

</html>